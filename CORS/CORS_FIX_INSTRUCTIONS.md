# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å Google –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π –∏ CORS

## –ü—Ä–æ–±–ª–µ–º–∞
–û—à–∏–±–∫–∞ CORS –ø—Ä–∏ Google –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: –∑–∞–ø—Ä–æ—Å —Å `localhost:3000` –Ω–∞ `localhost:3001/api/auth/sign-in/social`

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –û–±–Ω–æ–≤–ª–µ–Ω `auth-client.ts`
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ baseURL –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ origin
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `NEXT_PUBLIC_AUTH_URL` –∫–∞–∫ fallback

### 2. –î–æ–±–∞–≤–ª–µ–Ω—ã CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ `next.config.ts`
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS –¥–ª—è –≤—Å–µ—Ö API —Ä–æ—É—Ç–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### 3. –û–±–Ω–æ–≤–ª–µ–Ω—ã `trustedOrigins` –≤ `auth.ts`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ HTTPS
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `ALLOWED_ORIGINS`

### 4. ‚úÖ –£–ª—É—á—à–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ `route.ts` —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
- **–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Origin**: –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—Ç–∏–≤ whitelist –¥–æ–º–µ–Ω–æ–≤
- **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ dev/prod –ª–æ–≥–∏–∫–∏**: –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –±–æ–ª–µ–µ –≥–∏–±–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ —Å—Ç—Ä–æ–≥–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –¥–æ–º–µ–Ω–∞–º–∏**: `Access-Control-Allow-Origin` —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –¥–æ–º–µ–Ω–∞–º–∏
- **–î–æ–±–∞–≤–ª–µ–Ω `Vary: Origin` –∑–∞–≥–æ–ª–æ–≤–æ–∫**: –î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞–º–∏
- **–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ credentials**: –ë–æ–ª—å—à–µ –Ω–∏–∫–∞–∫–æ–≥–æ `*` —Å `credentials: true`
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ OPTIONS –∑–∞–ø—Ä–æ—Å–æ–≤**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ preflight –∑–∞–ø—Ä–æ—Å–æ–≤

## –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env.local` –≤ –ø–∞–ø–∫–µ `apps/web/` —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏:

```env
# Database
DATABASE_URL="postgresql://username:password@localhost:5432/legalai"

# Better Auth
BETTER_AUTH_SECRET="your-32-character-secret-key-here"
BETTER_AUTH_URL="http://localhost:3001"

# Google OAuth
GOOGLE_CLIENT_ID="your-google-client-id.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="your-google-client-secret"

# Next.js Public Variables
NEXT_PUBLIC_AUTH_URL="http://localhost:3001"

# CORS Settings
ALLOWED_ORIGINS="http://localhost:3000,http://localhost:3001"
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google OAuth

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [Google Cloud Console](https://console.cloud.google.com/)
2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
3. –í–∫–ª—é—á–∏—Ç–µ Google+ API
4. –°–æ–∑–¥–∞–π—Ç–µ OAuth 2.0 credentials
5. –í "Authorized redirect URIs" –¥–æ–±–∞–≤—å—Ç–µ:
   - `http://localhost:3001/api/auth/callback/google`
   - `http://localhost:3000/api/auth/callback/google` (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

## –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
cd apps/web
pnpm install
pnpm dev
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ `http://localhost:3001`

## –ü—Ä–æ–≤–µ—Ä–∫–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:3001`
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ Google
3. –ü—Ä–æ–±–ª–µ–º–∞ —Å CORS –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–µ—à–µ–Ω–∞

## üîí –î–µ—Ç–∞–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ CORS (–ò–°–ü–†–ê–í–õ–ï–ù–û)

### –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã:

#### ‚ùå –ë—ã–ª–æ (–Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ):
```ts
response.headers.set(
  'Access-Control-Allow-Origin', 
  process.env.NODE_ENV === 'development' 
    ? '*'  // ‚ö†Ô∏è –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ —Å credentials
    : 'http://localhost:3000,http://localhost:3001'  // ‚ö†Ô∏è –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
);
response.headers.set('Access-Control-Allow-Credentials', 'true');
```

#### ‚úÖ –°—Ç–∞–ª–æ (–±–µ–∑–æ–ø–∞—Å–Ω–æ):
```ts
const addCorsHeaders = (request: Request, response: Response) => {
  const origin = request.headers.get('origin');
  
  if (process.env.NODE_ENV === 'development') {
    // –í dev: —Ä–∞–∑—Ä–µ—à–∞–µ–º –ª—é–±–æ–π origin, –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ–≥–æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ
    if (origin) {
      response.headers.set('Access-Control-Allow-Origin', origin);
      response.headers.set('Access-Control-Allow-Credentials', 'true');
      response.headers.set('Vary', 'Origin');
    }
  } else {
    // –í prod: —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ whitelist
    const allowedOrigins = getAllowedOrigins();
    if (origin && allowedOrigins.includes(origin)) {
      response.headers.set('Access-Control-Allow-Origin', origin);
      response.headers.set('Access-Control-Allow-Credentials', 'true');
      response.headers.set('Vary', 'Origin');
    }
  }
};
```

### –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

1. **üõ° –ù–∏–∫–∞–∫–æ–≥–æ `*` —Å `credentials`**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∞—Ç–∞–∫–∏ CSRF –∏ –∫—Ä–∞–∂—É —Ç–æ–∫–µ–Ω–æ–≤
2. **üéØ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Origin**: –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ø—Ä–æ—Ç–∏–≤ whitelist
3. **üìã –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–∏—Å–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤
4. **‚ö° Vary: Origin –∑–∞–≥–æ–ª–æ–≤–æ–∫**: –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
5. **üîÑ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ dev/prod**: –£–¥–æ–±—Å—Ç–≤–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ + –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

```bash
# –¢–µ—Å—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å)
curl -H "Origin: http://localhost:3000" \
     -H "Access-Control-Request-Method: POST" \
     -X OPTIONS http://localhost:3001/api/auth/sign-in

# –¢–µ—Å—Ç –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ (–¥–æ–ª–∂–µ–Ω –æ—Ç–∫–ª–æ–Ω–∏—Ç—å—Å—è –≤ prod)
curl -H "Origin: http://malicious-site.com" \
     -H "Access-Control-Request-Method: POST" \
     -X OPTIONS http://localhost:3001/api/auth/sign-in
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –∑–∞–ø—É—â–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 3001
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
3. **–ü—Ä–∏ –¥–µ–ø–ª–æ–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω –æ–±–Ω–æ–≤–∏—Ç–µ `ALLOWED_ORIGINS`** —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–æ–º–µ–Ω–∞–º–∏:
   ```env
   ALLOWED_ORIGINS="https://yourdomain.com,https://www.yourdomain.com"
   ```
4. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `*` –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ** —Å `credentials: true`
5. **–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –¥–æ–º–µ–Ω–æ–≤
